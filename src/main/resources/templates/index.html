<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>PowerShell Terminal Web (Client-Server)</title>
    <style>
        body {
            font-family: 'Consolas', monospace;
            background-color: [[${theme.backgroundColor}]];
            color: [[${theme.textColor}]];
            margin: 0;
            padding: 20px;
        }

        .terminal-window {
            width: 80%;
            margin: 0 auto;
            border: 1px solid #555;
            height: 500px;
            padding: 10px;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
        }

        .output-area {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 10px;
            white-space: pre-wrap;
        }

        .input-area {
            display: flex;
            border-top: 1px solid #555;
            padding-top: 10px;
            align-items: center;
        }

        .prompt-container {
            margin-right: 10px;
        }

        input[type="text"] {
            flex-grow: 1;
            background-color: transparent;
            border: none;
            color: [[${theme.commandColor}]];
            font-family: 'Consolas', monospace;
            font-size: 16px;
            outline: none;
        }

        button {
            background-color: transparent;
            border: 1px solid [[${theme.textColor}]];
            color: [[${theme.textColor}]];
            padding: 5px 10px;
            cursor: pointer;
        }

        .history-line {
            margin-bottom: 2px;
        }

        .controls {
            width: 80%;
            margin: 0 auto 20px auto;
            text-align: right;
            display: flex;
            justify-content: flex-end;
            gap: 20px;
        }
    </style>
</head>
<body>

<div class="controls">
    <form action="/change-theme" method="post" style="display:inline;">
        <label>Theme: </label>
        <select name="themeName" onchange="this.form.submit()">
            <option value="dark" th:selected="${currentThemeName == 'dark'}">Dark</option>
            <option value="light" th:selected="${currentThemeName == 'light'}">Light</option>
        </select>
    </form>

    <form action="/change-engine" method="post" style="display:inline;">
        <label>Engine: </label>
        <select name="engineType" onchange="this.form.submit()">
            <option value="windows" th:selected="${currentEngine == 'windows'}">Windows PowerShell</option>
            <option value="mock" th:selected="${currentEngine == 'mock'}">Mock / Test</option>
        </select>
    </form>
</div>

<div class="terminal-window">
    <div class="output-area" id="output">
        <div th:each="line : ${history}" class="history-line" th:utext="${line}"></div>
    </div>

    <div class="input-area">
        <div class="prompt-container" th:utext="${promptHtml}"></div>

        <input type="text" id="commandInput" autofocus autocomplete="off" placeholder="Введіть команду..." />
        <button onclick="sendCommand()">Execute</button>
    </div>
</div>

<script>
    var output = document.getElementById("output");
    var input = document.getElementById("commandInput");

    function scrollToBottom() {
        output.scrollTop = output.scrollHeight;
    }
    scrollToBottom();

    input.addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            event.preventDefault();
            sendCommand();
        }
    });

    function sendCommand() {
        const commandText = input.value;
        if (!commandText.trim()) return;

        input.value = "";

        fetch('/api/execute', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ commandText: commandText })
        })
            .then(response => response.json())
            .then(data => {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'history-line';
                resultDiv.innerHTML = data.resultHtml;

                output.appendChild(resultDiv);
                scrollToBottom();
            })
            .catch(error => {
                console.error('Error:', error);
                const errorDiv = document.createElement('div');
                errorDiv.style.color = 'red';
                errorDiv.innerText = "Error connecting to server.";
                output.appendChild(errorDiv);
            });
    }
</script>

</body>
</html>